# ユーザー辞書の生成の仕方
2020/3/12 T. N. Hayashi

ここでは，ABC Treebank depCCG パーザーのための，janomeユーザー辞書の作り方を説明する．
あくまでも考え方であって，実際のスクリプトが以下の通りであるとは限らない．

## 目的
ABC Treebankでは，いくつかのモーダルをあえて形態素分析しないことにしている．
このうち，Unidicとの分析とが異なるものがある：

- 「なければならない」系
- 「はずがない」系
- 「かもしれない」系

これらのモーダルは，janomeユーザー辞書に登録しておくことにする．
そうすることで，janome tokenizerがこれらの語の分析をしないようにすることができる．

## 困難：活用
これらのモーダルは，活用をする．
具体的には，語尾の「ない」が，「形容詞」または「助動詞-ナイ」の活用の型を持つ．
また，これらのモーダルの口語系（例：「なきゃなんねぇ」）もある．

これらの変種を全て手で書くのは現実的ではない．
従って，何かしらのやり方で（半）自動生成しなければならない．

## janomeユーザー辞書・MeCabユーザー辞書・Unidic辞書
janomeユーザー辞書は，[MeCabユーザー辞書と同じ形式をしている](https://mocobeta.github.io/janome/#id10)．
また，[MeCabユーザー辞書](http://taku910.github.io/mecab/dic.html)は，Unidic辞書と似たような形を取っている．

従って，Unidic辞書（`lex.csv`）を活用して，欲しいエントリーを生成するのがよい．
`lex.csv` の列の意味は，[公式サイト](https://unidic.ninjal.ac.jp/faq#output)で確認することができる．

## Unidic辞書からの形態素の抜き出し
Unidic辞書（`lex.csv`）から抜き出すべき情報は以下の通り：

- モーダルの先頭の形態素の左文脈ID
- モーダルの末尾の形態素（ここでは，偶々みんな「ない」になっている）の右文脈ID
- モーダルの末尾の形態素のコスト
- モーダルの末尾の形態素の活用情報全て

モーダルの先頭の形態素のエントリーと，末尾の形態素のエントリーを抜き出す必要がある．必要なものは，具体的には：
- 「なければならない」系：先頭の「ない」（助動詞），末尾の「ない」（助動詞）
- 「はずがない」系：先頭の「はず」，末尾の「ない」（形容詞）
- 「かもしれない」系：先頭の「か」（終助詞），末尾の「ない」（助動詞）

それぞれを抽出する1行スクリプトは次の通り：
```sh
#「語彙素」 `$12` に制約をかけていくといい感じである

# 「ない」（形容詞）
# 「亡い」を排除するために，「書字形出現形」（$13）にも制約をかけている
cat lex.csv | awk 'BEGIN { FS=","; OFS="," } $12~/^無い$/ && $13~/無|な/ { print }' 

# 「ない」（助動詞）
cat lex.csv | awk 'FBEGIN { S=","; OFS="," } $12~/^ない$/ { print }' 

# 「はず」
cat lex.csv | awk 'BEGIN { FS=","; OFS="," } $12~/^筈$/ { print }' 

# 「か」（終助詞）
# 副助詞の「か」と区別するために，「品詞中分類」（$6）にも制約をかけている
cat lex.csv | awk 'BEGIN { FS=","; OFS="," } $12~/^か$/ && $6~/終助詞/ { print }' 
```

## 組み合わせ
集めた形態素のエントリーから，合成されたエントリーをつくる．
活用形の実現の多さが問題だったので，末尾の形態素（「ない」）をもとにしてつくることにする．

まず，2種類の「ない」を別々のファイルに保存しておく．
名前を，例えば `nai-adj.csv` と `nai-aux.csv` としておく．

次に，これらのcsvファイルのレコードを編集することを考える．awkが最適であろう．
「ない」のレコードを，モーダルの他の形態素をくっつけながら，MeCabユーザー辞書の形式に変換することを行う．

列の対応付けは以下の通り：

`lex.csv`の列：
```
表層形,左文脈ID,右文脈ID,コスト,品詞,品詞細分類1,品詞細分類2,品詞細分類3,活用型,活用形,語彙素読み,語彙素,書字形出現形,発音形出現形,書字形基本形,発音形基本形,語種,語頭変化形,語頭変化型,語尾変化形,語尾変化型,語頭変化結合形,語尾変化結合形,類,仮名形出現形,仮名形基本形,語形出現形,語形基本形,アクセント型,アクセント結合形,アクセント修飾型,語彙表ID,語彙素ID
```
参考：https://pbs.twimg.com/media/DMf3gFQUIAEZ6vx?format=jpg&name=large

MeCab辞書の列：
```
表層形,左文脈ID,右文脈ID,コスト,品詞,品詞細分類1,品詞細分類2,品詞細分類3,活用型,活用形,原形,読み,発音
```

ここで，

- MeCab原型 `$11` = `lex.csv` 書字形基本形 `$15`
- MeCab読み `$12` = `lex.csv` 仮名形出現形 `$25`
- MeCab発音 `$13` = `lex.csv` 発音形出現形 `$14`

である．

以下は，「ない」（形容詞）から「はずがない」のMeCabエントリーを生成するawkスクリプトである．

```awk
# csv入力・csv出力
BEGIN {
    FS = ",";
    OFS = ",";
}

{
    $1 = "はずが"$1; # 出現形
    $2 = 15822; # 左文脈ID：「はず」に合わせる
    $11 = "筈が"$15; # 書字形基本形
    $12 = "ハズガ"$25; # 仮名形出現形
    $13 = "ハズガ"$14; # 発音形

    for (i = 14; i <= NF; i++) {
        $i = ""
    }

    print;

    $1 = "筈が"$1; # 出現形
    $2 = 912; # 左文脈ID：「はず」に合わせる
    $11 = "筈が"$15; # 書字形基本形
    $12 = "ハズガ"$25; # 仮名形出現形
    $13 = "ハズガ"$14; # 発音形

    for (i = 14; i <= NF; i++) {
        $i = ""
    }

    print;

    $1 = "ハズが"$1; # 出現形
    $2 = 15822; # 左文脈ID：「はず」に合わせる
    $11 = "筈が"$15; # 書字形基本形
    $12 = "ハズガ"$25; # 仮名形出現形
    $13 = "ハズガ"$14; # 発音形

    for (i = 14; i <= NF; i++) {
        $i = ""
    }

    print;

    # ...
}
```

## エントリーコストの調整
...
